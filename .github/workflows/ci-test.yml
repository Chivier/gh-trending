name: CI Tests

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci

    - name: Verify packages
      run: |
        npm list || true

    - name: Build TypeScript
      run: |
        npm run build

    - name: Test API startup
      run: |
        # Start the API
        timeout 30s npm start &
        API_PID=$!

        # Wait for API to be ready
        echo "Waiting for API to start..."
        for i in {1..15}; do
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "✓ API started successfully"
            break
          fi
          echo "Waiting... ($i/15)"
          sleep 2
        done

        # Test API endpoints
        echo "Testing API endpoints..."
        curl -f http://localhost:8000/ || exit 1

        # Test trending endpoint (might be empty but should not error)
        curl -f http://localhost:8000/api/trending || exit 1

        # Stop API
        kill $API_PID || true

    - name: Test Frontend
      run: |
        # Verify frontend files exist
        ls -lah frontend/

        # Check if HTML is valid (basic check)
        grep -q "GitHub Trending Dashboard" frontend/index.html || exit 1

        echo "✓ Frontend files verified"

    - name: Run Tests
      run: |
        # Run tests if they exist
        npm test || echo "No tests configured"
