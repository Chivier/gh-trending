name: CI Tests

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify Python packages
      run: |
        pip list

    - name: Initialize database
      run: |
        # Create database directory
        mkdir -p data

        # Run database migrations
        alembic upgrade head

        # Verify database was created
        ls -lah *.db || true

    - name: Test API startup
      run: |
        # Start the API
        timeout 30s python src/api.py &
        API_PID=$!

        # Wait for API to be ready
        echo "Waiting for API to start..."
        for i in {1..15}; do
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "✓ API started successfully"
            break
          fi
          echo "Waiting... ($i/15)"
          sleep 2
        done

        # Test API endpoints
        echo "Testing API endpoints..."
        curl -f http://localhost:8000/ || exit 1

        # Test trending endpoint (might be empty but should not error)
        curl -f http://localhost:8000/api/trending || exit 1

        # Stop API
        kill $API_PID || true

    - name: Test Frontend
      run: |
        # Verify frontend files exist
        ls -lah frontend/

        # Check if HTML is valid (basic check)
        grep -q "GitHub Trending Dashboard" frontend/index.html || exit 1

        echo "✓ Frontend files verified"

    - name: Run Tests
      run: |
        # Run pytest if tests exist
        if [ -d "tests" ] || [ -f "test_*.py" ]; then
          pytest -v || echo "No tests found or tests failed"
        else
          echo "No tests directory found, skipping tests"
        fi
